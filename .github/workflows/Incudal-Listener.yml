import asyncio
import os
import base64
import re
import subprocess
import time
from telethon import TelegramClient, events

TG_APIS = os.getenv("TG_APIS")
GROUP = os.getenv("GROUP")
TARGET_IDS = os.getenv("TARGET_IDS", "").split(",")
LISTEN_SECONDS = int(os.getenv("LISTEN_SECONDS", "120"))
USE_API_ID = os.getenv("USE_API_ID")
USER_SESSION = os.getenv("USER_SESSION")

RESULTS = []

# 获取指定账号信息
api_id = None
api_hash = None
session_b64 = None
for item in TG_APIS.split(","):
    id_, hash_ = item.split(":")
    if id_ == USE_API_ID:
        api_id = int(id_)
        api_hash = hash_
        session_b64 = os.getenv(f"TG{id_}")
        break

if not all([api_id, api_hash, session_b64]):
    raise SystemExit(f"❌ 未找到指定 TG 账号 {USE_API_ID}")

session_file = f"TG{api_id}.session"
with open(session_file, "wb") as f:
    f.write(base64.b64decode(session_b64))

client = TelegramClient(session_file, api_id, api_hash)

CODE_REGEX = re.compile(r'\b[crdth]-[\w-]{8,40}\b')

@client.on(events.NewMessage(chats=GROUP))
async def handler(event):
    sender = await event.get_sender()
    text = event.raw_text
    sender_id = str(sender.id)

    print(f"收到消息 | 用户: {sender.username} | ID: {sender_id} | 内容: {text}", flush=True)

    if sender_id in TARGET_IDS:
        codes = CODE_REGEX.findall(text)
        if codes:
            codes_text = "\n".join(codes)
            os.environ["REDEEM_TEXT"] = codes_text
            print(f"匹配到兑换码: {codes_text}，开始调用 redeem.py", flush=True)
            try:
                process = subprocess.Popen(
                    ["python", "scripts/redeem.py"],
