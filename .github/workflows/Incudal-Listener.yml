name: Incudal TG Group Listener & Redeem

on:
  workflow_dispatch:

jobs:
  tg-listen:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install telethon requests

      - name: Run TG Listener
        env:
          # TG è´¦å·ä¿¡æ¯ï¼Œæ ¼å¼ api_id:api_hash,api_id:api_hash
          TG_APIS: ${{ secrets.TG_APIS }}

          # æ¯ä¸ª TG è´¦å·å¯¹åº”çš„ session base64
          TG11027029: ${{ secrets.TG11027029 }}
          TG12965303: ${{ secrets.TG12965303 }}

          # ç¾¤èŠä¿¡æ¯
          GROUP: "@incudal_com"

          # ç›®æ ‡æˆå‘˜ ID
          TARGET_IDS: "-1003435357437,1966630851"

          # ç›‘å¬æ—¶é—´ï¼ˆç§’ï¼‰
          LISTEN_SECONDS: 120

          # æŒ‡å®šè¦ä½¿ç”¨çš„ TG è´¦å·
          USE_API_ID: "11027029"

          # Incudal ç”¨æˆ· session
          USER_SESSION: ${{ secrets.USER_SESSION }}

        run: |
          mkdir -p scripts
          # å†™å…¥ TG Listener è„šæœ¬ï¼ˆå®žæ—¶æ‰“å° + å‰©ä½™æ—¶é—´ï¼‰
          cat > scripts/listen_group.py << 'EOF'
          import asyncio
          import os
          import base64
          import re
          import subprocess
          import time
          from telethon import TelegramClient, events

          TG_APIS = os.getenv("TG_APIS")
          GROUP = os.getenv("GROUP")
          TARGET_IDS = os.getenv("TARGET_IDS", "").split(",")
          LISTEN_SECONDS = int(os.getenv("LISTEN_SECONDS", "120"))
          USE_API_ID = os.getenv("USE_API_ID")
          USER_SESSION = os.getenv("USER_SESSION")

          RESULTS = []

          api_id = None
          api_hash = None
          session_b64 = None
          for item in TG_APIS.split(","):
              id_, hash_ = item.split(":")
              if id_ == USE_API_ID:
                  api_id = int(id_)
                  api_hash = hash_
                  session_b64 = os.getenv(f"TG{id_}")
                  break

          if not all([api_id, api_hash, session_b64]):
              raise SystemExit(f"âŒ æœªæ‰¾åˆ°æŒ‡å®š TG è´¦å· {USE_API_ID}")

          session_file = f"TG{api_id}.session"
          with open(session_file, "wb") as f:
              f.write(base64.b64decode(session_b64))

          client = TelegramClient(session_file, api_id, api_hash)

          CODE_REGEX = re.compile(r'\b[crdth]-[\w-]{8,40}\b')

          @client.on(events.NewMessage(chats=GROUP))
          async def handler(event):
              sender = await event.get_sender()
              text = event.raw_text
              sender_id = str(sender.id)

              print(f"æ”¶åˆ°æ¶ˆæ¯ | ç”¨æˆ·: {sender.username} | ID: {sender_id} | å†…å®¹: {text}", flush=True)

              if sender_id in TARGET_IDS:
                  codes = CODE_REGEX.findall(text)
                  if codes:
                      codes_text = "\n".join(codes)
                      os.environ["REDEEM_TEXT"] = codes_text
                      print(f"åŒ¹é…åˆ°å…‘æ¢ç : {codes_text}ï¼Œå¼€å§‹è°ƒç”¨ redeem.py", flush=True)
                      try:
                          process = subprocess.Popen(
                              ["python", "scripts/redeem.py"],
                              stdout=subprocess.PIPE,
                              stderr=subprocess.STDOUT,
                              text=True
                          )
                          for line in process.stdout:
                              print(line, end="", flush=True)
                          process.wait()
                          RESULTS.append(f"ç”¨æˆ· {sender.username}({sender_id}) æ¶ˆæ¯è§¦å‘ï¼š\n{codes_text}")
                      except Exception as e:
                          print(f"æ‰§è¡Œ redeem.py å¤±è´¥: {e}", flush=True)
                          RESULTS.append(f"ç”¨æˆ· {sender.username}({sender_id}) æ‰§è¡Œå¤±è´¥ï¼š{e}")

          async def send_summary():
              text = "ðŸ“Š TG æ¶ˆæ¯è§¦å‘å…‘æ¢ç»“æžœ\n\n" + "\n\n".join(RESULTS) if RESULTS else "ðŸ“Š æ²¡æœ‰è§¦å‘ä»»ä½•å…‘æ¢"
              await client.send_message("me", text)

          async def main():
              await client.start()
              print(f"âœ… å·²ç™»å½• TG ç”¨æˆ· {api_id}ï¼Œå¼€å§‹ç›‘å¬ç¾¤èŠæ¶ˆæ¯...", flush=True)

              start_time = time.time()
              while True:
                  elapsed = time.time() - start_time
                  remaining = LISTEN_SECONDS - elapsed
                  if remaining <= 0:
                      break
                  print(f"â± ç›‘å¬å‰©ä½™æ—¶é—´: {int(remaining)} ç§’", end="\r", flush=True)
                  await asyncio.sleep(1)

              print("\nâ° ç›‘å¬ç»“æŸï¼Œå‘é€æ±‡æ€»...", flush=True)
              await send_summary()
              await client.disconnect()
              print("âœ… ç›‘å¬ç»“æŸ", flush=True)

          if __name__ == "__main__":
              if not USER_SESSION:
                  raise RuntimeError("âŒ USER_SESSION æœªè®¾ç½®")
              asyncio.run(main())
          EOF

          # å†™å…¥ redeem.py è„šæœ¬ï¼ˆä¿æŒåŽŸæ ·ï¼‰
          cat > scripts/redeem.py << 'EOF'
          import os 
          import json
          import requests

          BASE_URL = "https://incudal.com"
          TIMEOUT = 15
          RESULT_FILE = os.path.join(os.getcwd(), "result.txt")

          def append_line(line):
              with open(RESULT_FILE, "a", encoding="utf-8") as f:
                  f.write(line + "\n")
              print(line, flush=True)

          def build_session():
              raw = os.environ.get("USER_SESSION")
              if not raw:
                  raise RuntimeError("âŒ USER_SESSION æœªè®¾ç½®")
              data = json.loads(raw)
              s = requests.Session()
              s.headers.update({
                  "authorization": data["auth_token"],
                  "user-agent": "Mozilla/5.0",
                  "accept": "application/json"
              })
              for c in data.get("cookies", []):
                  s.cookies.set(c["name"], c["value"], domain=c.get("domain"))
              return s

          def safe_json(r):
              try:
                  return r.json()
              except:
                  return {}

          def decode(code_type, value):
              return {
                  "cpu": "CPU",
                  "memory": "å†…å­˜",
                  "disk": "ç¡¬ç›˜",
                  "traffic": "æµé‡"
              }.get(code_type, code_type) + f" +{value}"

          def get_instances(session):
              try:
                  r = session.get(f"{BASE_URL}/api/instances", timeout=TIMEOUT)
                  r.raise_for_status()
                  return r.json().get("instances", [])
              except Exception as e:
                  append_line(f"âŒ èŽ·å–å®žä¾‹å¤±è´¥: {e}")
                  return []

          def redeem(session, code, instance_id):
              try:
                  append_line(f"ðŸš€ å¼€å§‹å…‘æ¢å®žä¾‹ {instance_id}ï¼š")
                  r = session.post(
                      f"{BASE_URL}/api/checkin/redeem",
                      json={"redeemCode": code, "instanceId": instance_id},
                      timeout=TIMEOUT
                  )
                  data = safe_json(r)
                  code_data = data.get("todayCode") if isinstance(data.get("todayCode"), dict) else data

                  if r.status_code == 200 and code_data and "codeType" in code_data:
                      result = f"âœ… {instance_id}: {decode(code_data['codeType'], code_data['codeValue'])}"
                      append_line(result)
                      return result
                  result = f"âŒ {instance_id}: {data.get('error','æœªçŸ¥é”™è¯¯')}"
                  append_line(result)
                  return result
              except Exception as e:
                  result = f"âŒ {instance_id}: å¼‚å¸¸ {e}"
                  append_line(result)
                  return result

          def main():
              open(RESULT_FILE, "w", encoding="utf-8").close()

              try:
                  session = build_session()
                  codes = [x.strip() for x in os.environ.get("REDEEM_TEXT", "").splitlines() if x.strip()]
                  if not codes:
                      append_line("âŒ æœªèŽ·å–åˆ°å…‘æ¢ç ï¼Œé€€å‡º")
                      return

                  instances = get_instances(session)
                  if not instances:
                      append_line("âŒ æ²¡æœ‰å®žä¾‹å¯å…‘æ¢")
                      return

                  for code in codes:
                      append_line(f"ðŸŽŸ å…‘æ¢ç  {code} å¼€å§‹")
                      for ins in instances:
                          redeem(session, code, ins["id"])

              except Exception as e:
                  append_line(f"âŒ è„šæœ¬å¼‚å¸¸: {e}")

              append_line("âœ… å…¨éƒ¨å…‘æ¢å®Œæˆ")

          if __name__ == "__main__":
              main()
          EOF

          # æ‰§è¡Œ TG Listener
          python scripts/listen_group.py
