name: GH_SESSION 自动更新 

on:
  workflow_dispatch:
  schedule:
    # 每 6 小时跑一次（你可以自行调整）
    - cron: "0 22 * * *"

jobs:
  update-session:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright pyotp pynacl requests
          playwright install chromium

      - name: Run GitHub session updater
        env:
          # GitHub 登录信息
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
          GH_PASSWORD: ${{ secrets.GH_PASSWORD }}
          GH_2FA_SECRET: ${{ secrets.GH_2FA_SECRET }}

          # 已有 Session（可为空）
          GH_SESSION: ${{ secrets.GH_SESSION }}

          # 更新 Secret 用
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

          # 代理（可选，不需要就删）
          PROXY: ${{ secrets.PROXY }}

          # Telegram 通知（engine/notify.py 使用）
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

        run: |
          python update_github_session.py
