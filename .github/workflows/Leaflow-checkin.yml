name: Leaflow è‡ªåŠ¨ç™»å½•ç­¾åˆ°

on:
  workflow_dispatch:
  schedule:
    - cron: "5 0,12 * * *"   # åŒ—äº¬æ—¶é—´ 08:05

concurrency:
  group: leaflow-checkin
  cancel-in-progress: true

jobs:
  checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      TZ: Asia/Shanghai
      SOCKS5_INFO: ${{ secrets.SOCKS5_INFO }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential socat tinyproxy \
            libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 \
            libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 \
            libxfixes3 libgbm1 libasound2 || true



      # ===============================
      # å¯åŠ¨æœ¬åœ° SOCKS5 æ˜ å°„ï¼ˆæ¯ä¸ªè´¦å·ç‹¬ç«‹ç«¯å£ï¼‰
      # ===============================
      - name: ğŸš€ Start local proxies
        run: |
          mkdir -p /tmp/leaflow_proxies
          IFS=',' read -ra PROXIES <<< "$SOCKS5_INFO"
          BASE_PORT=1081
          for idx in "${!PROXIES[@]}"; do
            p=${PROXIES[$idx]}
            USERPASS=${p%@*}
            HOSTPORT=${p#*@}
            USER=${USERPASS%%:*}
            PASS=${USERPASS#*:}
            HOST=${HOSTPORT%%:*}
            RPORT=${HOSTPORT#*:}

            LOCAL_PORT=$((BASE_PORT + idx))
            echo "âœ… æ˜ å°„ $HOST:$RPORT â†’ 127.0.0.1:$LOCAL_PORT"

            # ä½¿ç”¨ socat æ˜ å°„ SOCKS5 â†’ æœ¬åœ° TCP ç«¯å£
            nohup socat TCP-LISTEN:$LOCAL_PORT,fork SOCKS5:$HOST:0,socksuser=$USER,sockspass=$PASS &
          done
          sleep 3

      - name: ğŸ” Verify local proxy ports
        run: |
          ss -lntp | grep 108 || true

      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install -U pip
          pip install playwright requests[socks] pynacl cryptography
          playwright install chromium

      - name: â–¶ï¸ Run Leaflow Checkin
        env:
          LEAFLOW_ACCOUNTS: ${{ secrets.LEAFLOW_ACCOUNTS }}
          LEAFLOW_COOKIES:  ${{ secrets.LEAFLOW_COOKIES }}
          REPO_TOKEN:       ${{ secrets.REPO_TOKEN }}
          TG_BOT_TOKEN:     ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID:       ${{ secrets.TG_CHAT_ID }}
          CONFIG_PASSWORD: ${{ secrets.CONFIG_PASSWORD }}
        run: |
          python -u leaflow/Leaflow_checkin.py

      - name: ğŸ“¸ Upload Leaflow screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: leaflow-login-fail
          path: |
            **/*.png
