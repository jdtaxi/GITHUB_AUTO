name: Leaflow è‡ªåŠ¨ç™»å½•ç­¾åˆ° 

on:
  workflow_dispatch:
  schedule:
    - cron: "5 0,12 * * *"   # åŒ—äº¬æ—¶é—´ 08:05

concurrency:
  group: leaflow-checkin
  cancel-in-progress: true

jobs:
  checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      TZ: Asia/Shanghai

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libgbm1 \
            libasound2 || true

      # ===========================
      # âœ… æ–°å¢ï¼šå®‰è£… 3proxy
      # ===========================
      - name: ğŸ§© Install 3proxy
        run: sudo apt-get install -y 3proxy

      # ===========================
      # âœ… æ–°å¢ï¼šä» SOCKS5_INFO ç”Ÿæˆå¤šç«¯å£æœ¬åœ° SOCKS
      # ===========================
      - name: ğŸ§© Setup SOCKS5 forwarders
        env:
          SOCKS5_INFO: ${{ secrets.SOCKS5_INFO }}
        run: |
          python << 'EOF'
          import os

          raw = os.environ.get("SOCKS5_INFO", "").strip()
          if not raw:
              raise SystemExit("âŒ SOCKS5_INFO æœªè®¾ç½®")

          socks_list = [x.strip() for x in raw.split(",") if x.strip()]
          base_port = 1081

          lines = [
              "daemon",
              "maxconn 500",
              "nserver 8.8.8.8",
              "nserver 1.1.1.1",
              "timeouts 1 5 30 60 180 1800 15 60",
          ]

          for i, s in enumerate(socks_list):
              up, hp = s.split("@", 1)
              user, pwd = up.split(":", 1)
              host, port = hp.split(":", 1)

              local_port = base_port + i
              lines.append(f"socks -p{local_port}")
              lines.append(
                  f"parent 1000 socks5 {host} {port} {user} {pwd}"
              )

              print(f"âœ” SOCKS {host}:{port} â†’ 127.0.0.1:{local_port}")

          with open("3proxy.cfg", "w") as f:
              f.write("\n".join(lines))
          EOF

      # ===========================
      # âœ… æ–°å¢ï¼šå¯åŠ¨ 3proxy
      # ===========================
      - name: ğŸš€ Start 3proxy
        run: |
          3proxy 3proxy.cfg
          sleep 2
          ss -lntp | grep 108 || true

      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install -U pip
          pip install playwright requests[socks] pynacl cryptography
          playwright install chromium

      - name: â–¶ï¸ Run Leaflow Checkin
        env:
          LEAFLOW_ACCOUNTS: ${{ secrets.LEAFLOW_ACCOUNTS }}
          LEAFLOW_COOKIES:  ${{ secrets.LEAFLOW_COOKIES }}
          REPO_TOKEN:       ${{ secrets.REPO_TOKEN }}
          TG_BOT_TOKEN:     ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID:       ${{ secrets.TG_CHAT_ID }}
          CONFIG_PASSWORD: ${{ secrets.CONFIG_PASSWORD }}
        run: |
          python -u leaflow/Leaflow_checkin.py

      - name: ğŸ“¸ Upload Leaflow screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: leaflow-login-fail
          path: |
            **/*.png
