name: Leaflow Ëá™Âä®ÁôªÂΩïÁ≠æÂà∞

on:
  workflow_dispatch:
  schedule:
    - cron: "5 0,12 * * *"   # Âåó‰∫¨Êó∂Èó¥ 08:05

concurrency:
  group: leaflow-checkin
  cancel-in-progress: true

jobs:
  checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      TZ: Asia/Shanghai
      SOCKS5_INFO: ${{ secrets.SOCKS5_INFO }}  # Ê†ºÂºè: u1:p1@ip1:port1,u2:p2@ip2:port2,...

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential libnss3 libatk1.0-0 libatk-bridge2.0-0 \
          libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libgbm1 libasound2 \
          curl unzip || true

      # ===============================
      # ‰∏ãËΩΩÂπ∂ÁºñËØë 3proxy
      # ===============================
      - name: üß© Build 3proxy
        run: |
          git clone https://github.com/3proxy/3proxy.git
          cd 3proxy
          make -f Makefile.Linux
          sudo cp bin/3proxy /usr/local/bin/3proxy
          3proxy --version || true

      # ===============================
      # ÁîüÊàê 3proxy ÂÆ¢Êà∑Á´ØÈÖçÁΩÆÂπ∂ÂêØÂä®
      # ===============================
      - name: üöÄ Start local SOCKS5 proxies
        run: |
          mkdir -p /tmp/3proxy
          CONF=/tmp/3proxy/3proxy.cfg
          echo "daemon" > $CONF
          echo "maxconn 100" >> $CONF
          echo "nserver 8.8.8.8" >> $CONF
          echo "nscache 65536" >> $CONF
          echo "timeouts 1 5 30 60 180 1800 15 60" >> $CONF
          echo "log /tmp/3proxy/3proxy.log D" >> $CONF
          echo "auth strong" >> $CONF

          PORT=1081
          IFS=',' read -ra PROXIES <<< "$SOCKS5_INFO"
          for p in "${PROXIES[@]}"; do
            USERPASS=${p%@*}
            HOSTPORT=${p#*@}
            USER=${USERPASS%%:*}
            PASS=${USERPASS#*:}
            HOST=${HOSTPORT%%:*}
            RPORT=${HOSTPORT#*:}

            # ÈÖçÁΩÆÂÆ¢Êà∑Á´ØÊ®°ÂºèËΩ¨ÂèëÂà∞ËøúÁ®ã SOCKS5
            echo "socks -p$PORT -i127.0.0.1 -e$HOST -a -u $USER:$PASS" >> $CONF
            echo "‚úÖ Êò†Â∞ÑËøúÁ®ã $USER:$PASS@$HOST:$RPORT ‚Üí 127.0.0.1:$PORT"
            PORT=$((PORT+1))
          done

          sudo 3proxy $CONF &
          sleep 3

      - name: üîç Verify local proxy ports
        run: |
          ss -lntp | grep 108 || true

      - name: üì¶ Install Python dependencies
        run: |
          pip install -U pip
          pip install playwright requests[socks] pynacl cryptography
          playwright install chromium

      - name: ‚ñ∂Ô∏è Run Leaflow Checkin
        env:
          LEAFLOW_ACCOUNTS: ${{ secrets.LEAFLOW_ACCOUNTS }}
          LEAFLOW_COOKIES:  ${{ secrets.LEAFLOW_COOKIES }}
          REPO_TOKEN:       ${{ secrets.REPO_TOKEN }}
          TG_BOT_TOKEN:     ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID:       ${{ secrets.TG_CHAT_ID }}
          CONFIG_PASSWORD: ${{ secrets.CONFIG_PASSWORD }}
        run: |
          python -u leaflow/Leaflow_checkin.py

      - name: üì∏ Upload Leaflow screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: leaflow-login-fail
          path: |
            **/*.png
